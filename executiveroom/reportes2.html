<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reportes: Sala Ejecutiva</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --main-color: #003366;
      --accent-color: #007bff;
      --success-color: #28a745;
      --info-color: #17a2b8;
      --warning-color: #ff8000;
      --danger-color: #dc3545;
      --gray-light: #f5f5f5;
      --table-header-bg: linear-gradient(90deg, #003366 60%, #007bff 100%);
    }
    body {
      font-family: 'Segoe UI', 'Roboto', Arial, sans-serif;
      background: var(--gray-light);
      margin: 0;
    }
    .header {
      display: flex;
      align-items: center;
      background: var(--table-header-bg);
      color: #fff;
      padding: 16px 32px;
      border-bottom-left-radius: 16px;
      border-bottom-right-radius: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }
    .logo {
      height: 48px;
      width: auto;
      margin-right: 20px;
      border-radius: 8px;
      padding: 6px 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04);
    }
    .header-title {
      font-size: 2rem;
      font-weight: 600;
      margin: 0;
    }
    .container {
      max-width: 1200px;
      margin: 40px auto;
      background: #fff;
      padding: 32px 20px 24px 20px;
      border-radius: 16px;
      box-shadow: 0 6px 32px rgba(0,0,0,0.07);
    }
    h2 {
      color: var(--main-color);
      margin-top: 0;
      font-weight: 500;
    }
    table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin-top: 16px;
      background: #fff;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 2px 12px rgba(0,0,0,0.05);
    }
    th, td {
      padding: 12px 10px;
      text-align: left;
      font-size: 1rem;
    }
    th {
      background: var(--table-header-bg);
      color: #fff;
      position: sticky;
      top: 0;
      cursor: pointer;
      user-select: none;
      z-index: 2;
      font-weight: 600;
      letter-spacing: 0.5px;
    }
    tr:nth-child(even) {
      background: #f0f6fa;
    }
    tr:hover {
      background: #e2ebf3;
      transition: background 0.2s;
    }
    .status-nuevo {
      color: var(--warning-color);
      font-weight: 600;
    }
    .status-enprogreso {
      color: var(--accent-color);
      font-weight: 600;
    }
    .status-resuelto {
      color: var(--success-color);
      font-weight: 600;
    }
    .status-cerrado {
      color: #6c757d;
      font-weight: 600;
    }
    button.status-btn {
      padding: 7px 18px;
      background: var(--accent-color);
      color: #fff;
      border: none;
      border-radius: 22px;
      cursor: pointer;
      font-weight: 500;
      font-size: 0.98rem;
      transition: background 0.15s, box-shadow 0.15s;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      outline: none;
    }
    button.status-btn:hover, button.status-btn:focus {
      background: #0056b3;
      box-shadow: 0 4px 16px rgba(0,0,0,0.11);
    }
    .sort-arrow {
      font-size: 0.95em;
      margin-left: 5px;
    }
    @media (max-width: 900px) {
      .container { padding: 12px 2vw; }
      th, td { font-size: 0.98rem; padding: 8px 6px; }
      .header { flex-direction: column; align-items: flex-start; padding: 10px 10px; }
      .header-title { font-size: 1.2rem; }
      .logo { height: 40px; margin-right: 0; margin-bottom: 5px; }
    }
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr { display: block; }
      thead { display: none; }
      tr { margin-bottom: 20px; border-radius: 8px; background: #f7fafc; box-shadow: 0 1px 6px rgba(0,0,0,0.03);}
      td { position: relative; padding-left: 52%; min-height: 38px;}
      td:before {
        position: absolute;
        left: 12px;
        width: 45%;
        white-space: pre-wrap;
        font-weight: 600;
        color: #007bff;
      }
      /* Ajuste de los selectores nth-child para las columnas restantes */
      td:nth-child(1):before { content: "ID: "; }
      td:nth-child(2):before { content: "Título: "; }
      td:nth-child(3):before { content: "Descripción: "; }
      td:nth-child(4):before { content: "Estado: "; }
      td:nth-child(5):before { content: "Fecha Creación: "; }
      td:nth-child(6):before { content: "Fecha Actualización: "; }
      td:nth-child(7):before { content: "Reportado por: "; }
      td:nth-child(8):before { content: "Acción: "; }
    }
  </style>
</head>
<body>
  <div class="header">
    <!-- LOGO: Reemplaza src por la URL de tu logo si lo deseas -->
    <img class="logo" src="logo.png" alt="Logo">
    <span class="header-title">Reportes: Sala Ejecutiva</span>
  </div>
  <div class="container">
    <h2>Incidencias Reportadas</h2>
    <table id="ticketsTable">
      <thead>
        <tr>
          <th data-col="id">ID</th>
          <!-- Columnas 'ID Cliente' y 'Cliente' eliminadas -->
          <th data-col="title">Título</th>
          <th data-col="description">Descripción</th>
          <th data-col="status">Estado</th>
          <th data-col="created_at">Fecha Creación</th>
          <th data-col="updated_at">Fecha Actualización</th>
          <th data-col="reported_by">Reportado por</th>
          <th>Acción</th>
        </tr>
      </thead>
      <tbody>
        <!-- Las incidencias se mostrarán aquí -->
      </tbody>
    </table>
  </div>
  <script>
    const API_URL = 'https://68cc4bf9716562cf50772e08.mockapi.io/ticket';
    const statusSequence = ['Nuevo', 'En progreso', 'Resuelto', 'Cerrado'];

    let ticketsCache = [];
    let currentSort = { col: null, asc: true };

    function getNextStatus(current) {
      const idx = statusSequence.indexOf(current);
      if (idx === -1 || idx === statusSequence.length - 1) return null;
      return statusSequence[idx + 1];
    }

    function compareValues(a, b, asc, isDate = false) {
      if (isDate) {
        a = a ? new Date(a) : new Date(0);
        b = b ? new Date(b) : new Date(0);
      }
      if (a === b) return 0;
      if (a === null || a === undefined) return asc ? -1 : 1;
      if (b === null || b === undefined) return asc ? 1 : -1;
      if (typeof a === "number" && typeof b === "number") return asc ? a - b : b - a;
      return asc
        ? (a > b ? 1 : -1)
        : (a < b ? 1 : -1);
    }

    function renderTable() {
      const tbody = document.querySelector('#ticketsTable tbody');
      tbody.innerHTML = '';
      let tickets = [...ticketsCache];
      if (currentSort.col) {
        const isDate = ["created_at", "updated_at"].includes(currentSort.col);
        tickets.sort((a, b) => compareValues(a[currentSort.col], b[currentSort.col], currentSort.asc, isDate));
      }
      tickets.forEach(ticket => {
        const nextStatus = getNextStatus(ticket.status);
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${ticket.id ?? ''}</td>
          <!-- Datos de 'ID Cliente' y 'Cliente' eliminados -->
          <td>${ticket.title ?? ''}</td>
          <td>${ticket.description ?? ''}</td>
          <td class="status-${(ticket.status ?? '').replace(/\s+/g, '').toLowerCase()}">${ticket.status ?? ''}</td>
          <td>${ticket.created_at ? new Date(ticket.created_at).toLocaleString() : ''}</td>
          <td>${ticket.updated_at ? new Date(ticket.updated_at).toLocaleString() : ''}</td>
          <td>${ticket.reported_by ?? ''}</td>
          <td>
            ${
              nextStatus
                ? `<button class="status-btn" onclick="changeStatus(${ticket.id}, '${nextStatus}')">
                    Cambiar a "${nextStatus}"
                  </button>`
                : ''
            }
          </td>
        `;
        tbody.appendChild(tr);
      });

      // Actualizar flechas de ordenamiento
      document.querySelectorAll('th[data-col]').forEach(th => {
        th.innerHTML = th.textContent.replace(/[\u2191\u2193]/g, '');
        if (th.dataset.col === currentSort.col) {
          th.innerHTML += currentSort.asc
            ? ' <span class="sort-arrow">\u2191</span>'
            : ' <span class="sort-arrow">\u2193</span>';
        }
      });
    }

    async function loadTickets() {
      try {
        const res = await fetch(API_URL);
        ticketsCache = await res.json();
        renderTable();
      } catch (error) {
        console.error("Error al cargar las incidencias:", error);
      }
    }

    async function changeStatus(id, newStatus) {
      try {
        const res = await fetch(`${API_URL}/${id}`);
        const ticket = await res.json();
        await fetch(`${API_URL}/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            ...ticket,
            status: newStatus,
            updated_at: new Date().toISOString()
          })
        });
        loadTickets();
      } catch (error) {
        alert("Error al cambiar el estado. Intenta de nuevo.");
      }
    }

    window.changeStatus = changeStatus;

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('th[data-col]').forEach(th => {
        th.addEventListener('click', () => {
          const col = th.dataset.col;
          if (currentSort.col === col) {
            currentSort.asc = !currentSort.asc;
          } else {
            currentSort.col = col;
            currentSort.asc = true;
          }
          renderTable();
        });
      });
      loadTickets();
      setInterval(loadTickets, 5000);
    });
  </script>
</body>
</html>