<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Merka+ - Búsqueda de Pedidos por Cliente</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #0077cc; /* Azul principal de Merka+ */
      --secondary: #00bfa6; /* Teal/Verde secundario de Merka+ */
      --bg-light: #f9f9f9; /* Fondo claro */
      --text-dark: #333; /* Texto oscuro */
      --border-radius: 12px; /* Radio de borde general */
      --card-bg: #ffffff; /* Fondo de las tarjetas de pedido */
      --column-bg: #eef2f6; /* Fondo de las columnas de estado */
      --status-received: #ffc107; /* Amarillo para 'Recibido' */
      --status-preparing: #17a2b8; /* Azul claro para 'Preparando' */
      --status-shipped: var(--primary); /* Azul principal para 'Enviado' */
      --button-bg-received: #ffc107;
      --button-bg-preparing: #17a2b8;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-light);
      color: var(--text-dark);
      line-height: 1.6;
    }

    /* Encabezado - Estilo de Merka+ */
    header {
      background-color: var(--primary);
      color: white;
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    header img {
      height: 50px;
    }

    nav a {
      color: white;
      margin-left: 1.5rem;
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s ease;
    }

    nav a:hover {
      color: var(--secondary);
    }

    /* Sección Principal de Búsqueda */
    .search-container {
      padding: 2rem;
      max-width: 900px;
      margin: 0 auto;
      background-color: var(--card-bg);
      border-radius: var(--border-radius);
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      margin-top: 2rem;
    }

    .search-container h1 {
      text-align: center;
      color: var(--primary);
      margin-bottom: 1.5rem;
      font-size: 2.2rem;
      font-weight: 700;
    }

    .search-input-group {
      display: flex;
      gap: 1rem;
      margin-bottom: 2rem;
      flex-wrap: wrap; /* Permite que los elementos se envuelvan en pantallas pequeñas */
      justify-content: center;
    }

    .search-input-group input[type="text"] {
      flex-grow: 1; /* Permite que el input crezca */
      padding: 0.8rem 1rem;
      border: 1px solid #ccc;
      border-radius: var(--border-radius);
      font-size: 1rem;
      min-width: 200px; /* Ancho mínimo para el input */
    }

    .search-input-group button {
      padding: 0.8rem 1.5rem;
      background-color: var(--primary);
      color: white;
      border: none;
      border-radius: var(--border-radius);
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: background-color 0.3s ease;
    }

    .search-input-group button:hover {
      background-color: var(--secondary);
    }

    /* Contenedor de resultados */
    #searchResults {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* Columnas responsivas */
      gap: 1.5rem;
      margin-top: 2rem;
    }

    /* Estilos de las tarjetas de pedido (reutilizados del dashboard) */
    .order-card {
      background-color: var(--card-bg);
      padding: 1rem;
      border-radius: var(--border-radius);
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-left: 5px solid; /* Borde izquierdo para indicar el estado */
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .order-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .order-card h4 {
      color: var(--text-dark);
      margin-bottom: 0.5rem;
      font-size: 1.1rem;
      font-weight: 600;
    }

    .order-card p {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 0.3rem;
    }

    .order-card .status-indicator {
      font-weight: 700;
      color: var(--primary);
      margin-top: 0.5rem;
      margin-bottom: 1rem;
    }

    .order-card button {
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 0.6rem 1rem;
      border-radius: var(--border-radius); /* Usar --border-radius para consistencia */
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 600;
      transition: background-color 0.3s ease;
      align-self: flex-end;
      margin-top: 1rem; /* Espacio entre contenido y botón */
    }

    .order-card button:hover {
      opacity: 0.9;
    }

    /* Colores específicos para el borde de las tarjetas según el estado */
    .order-card[data-status="received"] { border-left-color: var(--status-received); }
    .order-card[data-status="preparing"] { border-left-color: var(--status-preparing); }
    .order-card[data-status="shipped"] { border-left-color: var(--status-shipped); }

    /* Colores específicos para el texto del estado dentro de las tarjetas */
    .order-card[data-status="received"] .status-indicator { color: var(--status-received); }
    .order-card[data-status="preparing"] .status-indicator { color: var(--status-preparing); }
    .order-card[data-status="shipped"] .status-indicator { color: var(--status-shipped); }

    /* Colores de botón según el estado */
    .order-card button.received-btn { background-color: var(--button-bg-received); }
    .order-card button.preparing-btn { background-color: var(--button-bg-preparing); }
    .order-card button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    /* Pie de Página - Estilo de Merka+ */
    footer {
      background-color: var(--primary);
      color: white;
      text-align: center;
      padding: 1rem;
      margin-top: 3rem;
      border-top: 4px solid var(--secondary);
    }

    /* Ajustes Responsivos */
    @media (max-width: 768px) {
      header {
        flex-direction: column;
        text-align: center;
        padding: 1rem;
      }
      nav {
        margin-top: 0.8rem;
      }
      nav a {
        margin: 0 0.5rem;
        font-size: 0.9rem;
      }
      .search-container {
        padding: 1rem;
        margin-top: 1rem;
      }
      .search-container h1 {
        font-size: 1.8rem;
      }
      .search-input-group {
        flex-direction: column;
        gap: 0.8rem;
      }
      .search-input-group input[type="text"],
      .search-input-group button {
        width: 100%;
      }
      #searchResults {
        grid-template-columns: 1fr; /* Una columna en pantallas muy pequeñas */
        gap: 1rem;
      }
      .order-card {
        padding: 0.8rem;
      }
      .order-card h4 {
        font-size: 1rem;
      }
      .order-card p {
        font-size: 0.85rem;
      }
      .order-card button {
        padding: 0.5rem 0.8rem;
        font-size: 0.8rem;
      }
      footer {
        margin-top: 2rem;
      }
    }
  </style>
</head>
<body>

<header>
  <img src="logo.jpg" alt="Logo Merka+">
  <nav>
    <a href="index.html">Dashboard de Pedidos</a> <!-- Enlace a tu página principal de gestión -->
    <a href="#">Productos</a>
    <a href="#">Promociones</a>
    <a href="search.html">Buscar Pedidos</a> <!-- Enlace a esta página -->
  </nav>
</header>

<main>
  <section class="search-container">
    <h1>Buscar Pedidos por Cliente</h1>

    <div class="search-input-group">
      <input type="text" id="customerSearchInput" placeholder="Ingrese el nombre del cliente">
      <button onclick="searchOrders()">Buscar Pedidos</button>
    </div>

    <div id="searchResults">
      <!-- Los pedidos encontrados se mostrarán aquí -->
      <p id="noResultsMessage" style="text-align: center; color: #666; display: none;">No se encontraron pedidos para este cliente.</p>
    </div>
  </section>
</main>

<footer>
  &copy; 2025 Merka+. Todos los derechos reservados.
</footer>

<script>
  // ¡¡¡IMPORTANTE!!! REEMPLAZA ESTA URL CON LA TUYA DE MOCKAPI.IO
  const MOCKAPI_URL = 'https://686f1c1891e85fac429fcd60.mockapi.io/pedidos';
  const WEBHOOK_URL = 'https://hooks.us.webexconnect.io/events/QW1I70QW3Y'; // Tu URL de Webhook

  const searchResultsContainer = document.getElementById('searchResults');
  const noResultsMessage = document.getElementById('noResultsMessage');

  /**
   * Envía una solicitud POST al Webhook con el ID de pedido y el estado.
   * @param {string} orderId - El ID del pedido (el que se muestra al usuario, e.g., "PEDIDO_XYZ_123").
   * @param {string} status - El nuevo estado del pedido (ej. "preparando envio", "enviado").
   */
  async function sendWebhookUpdate(orderId, status) {
      if (!orderId) {
          console.error('Error: El ID de pedido para el Webhook no está definido.');
          return;
      }

      const payload = {
          orderId: orderId,
          status: status
      };

      try {
          const response = await fetch(WEBHOOK_URL, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify(payload)
          });

          if (response.ok) {
              console.log(`Webhook enviado exitosamente para el pedido ${orderId} con estado: ${status}.`);
          } else {
              const errorText = await response.text();
              console.error(`Error al enviar el Webhook para el pedido ${orderId}: ${response.status} ${response.statusText} - ${errorText}`);
              alert(`Error al enviar el Webhook para el pedido ${orderId}. Código: ${response.status}`);
          }
      } catch (error) {
          console.error(`Error de red al enviar el Webhook para el pedido ${orderId}:`, error);
          alert(`Error de conexión al enviar el Webhook para el pedido ${orderId}.`);
      }
  }

  // Función para crear una tarjeta de pedido HTML (reutilizada)
  function createOrderCard(order) {
    const card = document.createElement('div');
    card.className = 'order-card';
    card.dataset.orderId = order.id; // ID de MockAPI
    card.dataset.status = order.status; // Para aplicar estilos CSS dinámicamente

    let buttonHtml = '';
    let buttonClass = '';
    let buttonText = '';
    let nextStatus = '';
    let currentStatusText = '';

    switch (order.status) {
      case 'received':
        buttonText = 'Marcar como Preparando Envío';
        buttonClass = 'received-btn';
        nextStatus = 'preparing';
        currentStatusText = 'Estado: Recibido';
        break;
      case 'preparing':
        buttonText = 'Marcar como Enviado';
        buttonClass = 'preparing-btn';
        nextStatus = 'shipped';
        currentStatusText = 'Estado: En Preparación';
        break;
      case 'shipped':
        buttonText = 'Pedido Enviado';
        buttonClass = 'shipped-btn';
        nextStatus = ''; // No hay siguiente estado
        currentStatusText = 'Estado: Enviado';
        break;
    }

    if (order.status !== 'shipped') {
      buttonHtml = `<button class="${buttonClass}" data-next-status="${nextStatus}">
                      ${buttonText}
                    </button>`;
    } else {
      buttonHtml = `<button disabled>
                      ${buttonText}
                    </button>`;
    }

    card.innerHTML = `
      <div>
        <h4>Pedido #${order.orderId}</h4>
        <p>Cliente: ${order.customerName}</p>
        <p>ID Cliente: ${order.customerID}</p>
        <p>Productos: ${order.items}</p>
        <p>Total: ${order.costo} MXN</p>
        <p class="status-indicator">${currentStatusText}</p>
      </div>
      ${buttonHtml}
    `;

    // Añadir el event listener al botón si existe y no está deshabilitado
    const button = card.querySelector('button:not([disabled])');
    if (button) {
      button.addEventListener('click', () => {
        const newStatus = button.dataset.nextStatus;
        // Pasa tanto el ID de MockAPI (order.id) como el ID de negocio (order.orderId)
        updateOrderStatus(order.id, order.orderId, newStatus);
      });
    }

    return card;
  }

  // Función para actualizar el estado de un pedido en MockAPI.io y enviar al Webhook (reutilizada)
  async function updateOrderStatus(mockApiOrderId, businessOrderId, newStatus) {
    try {
      const response = await fetch(`${MOCKAPI_URL}/${mockApiOrderId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ status: newStatus })
      });

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      console.log(`Pedido ${mockApiOrderId} actualizado a ${newStatus} en MockAPI.`);

      // Determinar el estado legible para el Webhook
      let webhookStatus;
      if (newStatus === 'preparing') {
        webhookStatus = 'preparando envio';
      } else if (newStatus === 'shipped') {
        webhookStatus = 'enviado';
      }

      // Llamar al Webhook después de la actualización exitosa en MockAPI
      if (webhookStatus) {
        await sendWebhookUpdate(businessOrderId, webhookStatus);
      }

      // Volver a ejecutar la búsqueda para reflejar el cambio en la UI
      searchOrders();
    } catch (error) {
      console.error('Error al actualizar el estado del pedido o enviar webhook:', error);
      alert('Error al actualizar el estado del pedido. Por favor, intente de nuevo.');
    }
  }

  // Función principal para buscar pedidos por cliente
  async function searchOrders() {
    const customerName = document.getElementById('customerSearchInput').value.trim();
    searchResultsContainer.innerHTML = ''; // Limpiar resultados anteriores
    noResultsMessage.style.display = 'none'; // Ocultar mensaje de no resultados

    if (customerName === '') {
      alert('Por favor, ingrese un nombre de cliente para buscar.');
      return;
    }

    try {
      const response = await fetch(MOCKAPI_URL);
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      const allOrders = await response.json();

      const filteredOrders = allOrders.filter(order =>
        order.customerName && order.customerName.toLowerCase().includes(customerName.toLowerCase())
      );

      if (filteredOrders.length > 0) {
        filteredOrders.forEach(order => {
          const card = createOrderCard(order);
          searchResultsContainer.appendChild(card);
        });
      } else {
        noResultsMessage.style.display = 'block'; // Mostrar mensaje de no resultados
      }

    } catch (error) {
      console.error('Error al buscar pedidos:', error);
      alert('Error al buscar pedidos. Por favor, intente de nuevo más tarde.');
    }
  }

  // Opcional: Si quieres que al cargar la página se muestren todos los pedidos o una búsqueda inicial.
  // document.addEventListener('DOMContentLoaded', () => {
  //   // Puedes llamar a searchOrders() aquí con un valor predeterminado si quieres
  //   // Por ejemplo, para mostrar todos los pedidos al inicio:
  //   // document.getElementById('customerSearchInput').value = '';
  //   // searchOrders();
  // });
</script>

</body>
</html>